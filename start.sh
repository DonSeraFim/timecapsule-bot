#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ Time Capsule Bot –Ω–∞ Railway..."

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫–∏
mkdir -p media

# –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
while true; do
    echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
    python3 bot.py &
    BOT_PID=$!
    
    echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å..."
    gunicorn --bind 0.0.0.0:$PORT --workers 1 --threads 2 --timeout 120 admin_panel:app &
    ADMIN_PID=$!
    
    # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    wait $BOT_PID
    BOT_EXIT_CODE=$?
    
    echo "‚ö†Ô∏è  –ë–æ—Ç —É–ø–∞–ª —Å –∫–æ–¥–æ–º $BOT_EXIT_CODE"
    echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –±–æ—Ç–∞:"
    tail -50 bot.log 2>/dev/null || echo "–§–∞–π–ª –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"
    
    # –£–±–∏–≤–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
    kill $ADMIN_PID 2>/dev/null
    
    echo "‚è≥ –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º..."
    sleep 5
done
